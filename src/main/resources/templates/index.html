<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v6.2.0/js/all.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <meta charset="UTF-8">
    <title>WFPS Incidents</title>

    <link rel="stylesheet" href="https://bootswatch.com/5/minty/bootstrap.css" />
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>
<div class="container-fluid">

    <div class="row">
        <div class="col-md-6">
            <h1 style="text-align:center">WFPS Active Incident Map:</h1>
            <div id="map" style="width: 100%; height: 100vh"></div>

        </div>
        <div class="col-md-6">
            <table class="table table-hover">
                <tr>
                    <th>Incident Type</th>
                    <th>Motor Vehicle Incident?</th>
                    <th>Neighbourhood</th>
                    <th>Call Time</th>
                    <th>Units Dispatched</th>
                    <th>Ward</th>
                    <th>Incident Number</th>
                </tr>
                <tr th:each="data: ${incidents}">
                    <td><span th:text="${data.INCIDENT_TYPE}"></span></td>
                    <td><span th:text="${data.IS_MOTOR}"></span></td>
                    <td><span th:text="${data.NEIGHBOURHOOD}"></span></td>
                    <td><span th:text="${data.CALL_TIME}"></span></td>
                    <td><span th:text="${data.UNITS}"></span></td>
                    <td><span th:text="${data.WARD}"></span></td>
                    <td><span th:text="${data.INCIDENT_NUMBER}"></span></td>
                </tr>
            </table>
        </div>
    </div>
</div>
</body>

</html>

<script th:inline="javascript">
    const incidents = /*[[${incidents}]]*/ [];

    const map = L.map('map').setView([49.8951, -97.1384], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const neighbourhoodCoordinatesCache = {};

    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>'"]/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            "'": '&#39;',
            '"': '&quot;'
        }[char]));
    }

    async function geocodeNeighbourhood(neighbourhoodName) {
        if (!neighbourhoodName) {
            return null;
        }
        if (neighbourhoodCoordinatesCache[neighbourhoodName]) {
            return neighbourhoodCoordinatesCache[neighbourhoodName];
        }

        const query = encodeURIComponent(`${neighbourhoodName}, Winnipeg, Manitoba, Canada`);
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${query}`);
        if (!response.ok) {
            return null;
        }

        const results = await response.json();
        if (!results.length) {
            return null;
        }

        const coordinates = [parseFloat(results[0].lat), parseFloat(results[0].lon)];
        neighbourhoodCoordinatesCache[neighbourhoodName] = coordinates;
        return coordinates;
    }

    async function buildNeighbourhoodCoordinateIndex() {
        const neighbourhoods = [...new Set(
            incidents
                .map((incident) => incident.NEIGHBOURHOOD)
                .filter((neighbourhood) => neighbourhood)
        )];

        await Promise.all(neighbourhoods.map(async (neighbourhood) => {
            await geocodeNeighbourhood(neighbourhood);
        }));
    }

    async function plotIncidents() {
        await buildNeighbourhoodCoordinateIndex();

        for (const incident of incidents) {
            const coordinates = neighbourhoodCoordinatesCache[incident.NEIGHBOURHOOD];
            if (!coordinates) {
                continue;
            }

            const popup = `
                <strong>${escapeHtml(incident.INCIDENT_TYPE)}</strong><br/>
                Neighbourhood: ${escapeHtml(incident.NEIGHBOURHOOD)}<br/>
                Units: ${escapeHtml(incident.UNITS ?? 'No Response')}<br/>
                Call Time: ${escapeHtml(incident.CALL_TIME)}
            `;

            L.circleMarker(coordinates, {
                radius: 7,
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.6
            }).addTo(map).bindPopup(popup);
        }
    }

    plotIncidents();
</script>
