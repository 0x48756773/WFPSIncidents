<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v6.2.0/js/all.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <meta charset="UTF-8">
    <title>WFPS Incidents</title>

    <link rel="stylesheet" href="https://bootswatch.com/5/minty/bootstrap.css" />
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>
<div class="container-fluid">

    <div class="row">
        <div class="col-md-6">
            <h1 style="text-align:center">WFPS Active Incident Map:</h1>
            <div id="map" style="width: 100%; height: 100vh"></div>

        </div>
        <div class="col-md-6">
            <table class="table table-hover">
                <tr>
                    <th>Incident Type</th>
                    <th>Motor Vehicle Incident?</th>
                    <th>Neighbourhood</th>
                    <th>Call Time</th>
                    <th>Units Dispatched</th>
                    <th>Ward</th>
                    <th>Incident Number</th>
                </tr>
                <tr th:each="data: ${incidents}">
                    <td><span th:text="${data.INCIDENT_TYPE}"></span></td>
                    <td><span th:text="${data.IS_MOTOR}"></span></td>
                    <td><span th:text="${data.NEIGHBOURHOOD}"></span></td>
                    <td><span th:text="${data.CALL_TIME}"></span></td>
                    <td><span th:text="${data.UNITS}"></span></td>
                    <td><span th:text="${data.WARD}"></span></td>
                    <td><span th:text="${data.INCIDENT_NUMBER}"></span></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const incidents = /*[[${incidents}]]*/ [];

    const map = L.map('map').setView([49.8951, -97.1384], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const neighbourhoodCoordinatesCache = {};
    const geocodeFailures = new Set();
    const wardCentres = {
        'Assiniboia': [49.8573, -97.2835],
        'Charleswood - Tuxedo - Westwood': [49.8569, -97.2525],
        'Daniel McIntyre': [49.9022, -97.1687],
        'Elmwood - East Kildonan': [49.9307, -97.0708],
        'Fort Garry': [49.8232, -97.1520],
        'Mynarski': [49.9290, -97.1483],
        'North Kildonan': [49.9545, -97.0671],
        'Old Kildonan': [49.9760, -97.1128],
        'Point Douglas': [49.9077, -97.1150],
        'River Heights - Fort Garry': [49.8584, -97.1748],
        'St. Boniface': [49.8864, -97.1080],
        'St. James': [49.8857, -97.2147],
        'St. Norbert - Seine River': [49.7707, -97.1543],
        'St. Vital': [49.8344, -97.1118],
        'Transcona': [49.8966, -97.0010],
        'Waverley West': [49.7927, -97.1854]
    };

    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>'"]/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            "'": '&#39;',
            '"': '&quot;'
        }[char]));
    }

    function jitterCoordinates(baseCoordinates, seedText) {
        if (!baseCoordinates) {
            return null;
        }

        let hash = 0;
        for (const character of String(seedText ?? '')) {
            hash = ((hash << 5) - hash) + character.charCodeAt(0);
            hash |= 0;
        }

        const latJitter = ((hash & 15) - 8) * 0.0007;
        const lngJitter = (((hash >> 4) & 15) - 8) * 0.0007;
        return [baseCoordinates[0] + latJitter, baseCoordinates[1] + lngJitter];
    }

    async function geocodeNeighbourhood(neighbourhoodName) {
        if (!neighbourhoodName) {
            return null;
        }
        if (neighbourhoodCoordinatesCache[neighbourhoodName]) {
            return neighbourhoodCoordinatesCache[neighbourhoodName];
        }
        if (geocodeFailures.has(neighbourhoodName)) {
            return null;
        }

        const query = encodeURIComponent(`${neighbourhoodName}, Winnipeg, Manitoba, Canada`);
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${query}`);
            if (!response.ok) {
                geocodeFailures.add(neighbourhoodName);
                return null;
            }

            const results = await response.json();
            if (!results.length) {
                geocodeFailures.add(neighbourhoodName);
                return null;
            }

            const coordinates = [parseFloat(results[0].lat), parseFloat(results[0].lon)];
            neighbourhoodCoordinatesCache[neighbourhoodName] = coordinates;
            return coordinates;
        } catch (error) {
            geocodeFailures.add(neighbourhoodName);
            return null;
        }
    }

    async function getIncidentCoordinates(incident) {
        const neighbourhood = incident.NEIGHBOURHOOD;
        const geocodedCoordinates = await geocodeNeighbourhood(neighbourhood);
        if (geocodedCoordinates) {
            return jitterCoordinates(geocodedCoordinates, incident.INCIDENT_NUMBER);
        }

        const wardCoordinates = wardCentres[incident.WARD];
        if (wardCoordinates) {
            return jitterCoordinates(wardCoordinates, incident.INCIDENT_NUMBER);
        }

        return null;
    }

    async function plotIncidents() {
        for (const incident of incidents) {
            const coordinates = await getIncidentCoordinates(incident);
            if (!coordinates) {
                continue;
            }

            const popup = `
                <strong>${escapeHtml(incident.INCIDENT_TYPE)}</strong><br/>
                Neighbourhood: ${escapeHtml(incident.NEIGHBOURHOOD)}<br/>
                Units: ${escapeHtml(incident.UNITS ?? 'No Response')}<br/>
                Call Time: ${escapeHtml(incident.CALL_TIME)}
            `;

            L.circleMarker(coordinates, {
                radius: 7,
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.6
            }).addTo(map).bindPopup(popup);
        }
    }

    plotIncidents();
</script>
</body>
</html>
